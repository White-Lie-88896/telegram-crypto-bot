# 📋 功能清单

> Telegram 加密货币监控 Bot 完整功能文档

---

## 📊 项目概览

| 指标 | 数值 |
|------|------|
| **源代码行数** | 3,600+ |
| **Python模块** | 19个 |
| **测试用例** | 39个（100%通过） |
| **Telegram命令** | 7个 |
| **监控规则** | 2种 |
| **数据来源** | Binance + CoinGecko（自动故障转移） |

---

## 🎯 核心功能

### 1. 💰 实时价格查询

**命令格式**：
```
/price <币种>
```

**使用示例**：
```
/price BTC      # 查询比特币价格
/price ETH      # 查询以太坊价格
/price SOL      # 查询Solana价格
/price ADA      # 查询艾达币价格
```

**功能特性**：
- ✅ 支持查询任意加密货币实时价格
- ✅ 显示24小时最高价/最低价
- ✅ 显示24小时涨跌幅（带趋势箭头 ↗️/↘️）
- ✅ 显示24小时成交量
- ✅ 精确到毫秒的更新时间
- ✅ 美观的Markdown格式排版
- ✅ 智能价格格式化（自动调整小数位）

**数据来源**：
- 🔗 主API：Cryptocompare（Binance数据）
- 🔗 备用API1：CoinGecko
- 🔗 备用API2：Binance官方API
- 🔗 所有消息显示实际使用的API来源

**消息示例**：
```
💰 BTC 价格信息

━━━━━━━━━━━━━━━━━━━━━━
📊 当前价格：$89,915.00
━━━━━━━━━━━━━━━━━━━━━━

24h 最高：$90,961.81
24h 最低：$88,459.96
24h 涨跌：+0.73% ↗️
24h 成交量：15,101.53 BTC

⏰ 更新时间：03:45:23
💡 数据来源：CoinGecko
```

---

### 2. 🚨 智能价格预警系统

#### 2.1 📌 价格阈值监控

**命令格式**：
```
/add <币种> price <阈值>
/add <币种> price high <上限>
/add <币种> price low <下限>
/add <币种> price <上限> <下限>
```

**使用示例**：
```
# 单一上限预警
/add BTC price 50000

# 明确指定上限
/add BTC price high 50000

# 明确指定下限
/add BTC price low 40000

# 同时设置上下限
/add ETH price 3500 2800
```

**功能特性**：
- ✅ 价格突破上限时自动推送通知
- ✅ 价格跌破下限时自动推送通知
- ✅ 可同时设置上下限双向监控
- ✅ 灵活的命令格式（支持多种输入方式）
- ✅ 触发后有5分钟冷却期

**预警消息示例**：
```
🔴 BTC 价格预警

━━━━━━━━━━━━━━━━━━━━━━
当前价格: $50,125.00
已达到上限: $50,000.00
━━━━━━━━━━━━━━━━━━━━━━

📈 突破上限阈值！

💡 数据来源: CoinGecko
```

#### 2.2 📈 百分比涨跌监控

**命令格式**：
```
/add <币种> percent <参考价> <涨幅%> <跌幅%>
```

**使用示例**：
```
# BTC相对90000美元，涨5%或跌5%时预警
/add BTC percent 90000 5 -5

# ETH相对3000美元，涨10%或跌10%时预警
/add ETH percent 3000 10 -10
```

**功能特性**：
- ✅ 基于参考价格监控涨跌幅
- ✅ 自动计算当前涨跌百分比
- ✅ 支持双向百分比阈值
- ✅ 精准的涨跌趋势提示
- ✅ 实时百分比计算

**预警消息示例**：
```
📈 BTC 涨幅预警

━━━━━━━━━━━━━━━━━━━━━━
当前价格: $95,000.00
参考价格: $90,000.00
涨幅: +5.56%
━━━━━━━━━━━━━━━━━━━━━━

🔥 涨幅已达 5%！

💡 数据来源: CoinGecko
```

---

### 3. 🎛️ 监控任务管理

#### 3.1 📋 查看任务列表

**命令**：
```
/list
```

**功能特性**：
- ✅ 显示所有活跃监控任务
- ✅ 显示任务ID、币种、规则类型
- ✅ 显示具体阈值配置
- ✅ 显示任务状态（ACTIVE/PAUSED）
- ✅ 美观的列表格式

**消息示例**：
```
📊 监控任务列表 (3)

✅ BTC
   🔺 上限: $50,000.00
   🆔 ID: 1

✅ ETH
   📌 参考: $3,000.00
   📈 涨 5%
   📉 跌 5%
   🆔 ID: 2

✅ SOL
   🔻 下限: $100.00
   🆔 ID: 3

💡 使用 /delete <ID> 删除任务
```

#### 3.2 🗑️ 删除监控任务

**命令格式**：
```
/delete <任务ID>
```

**使用示例**：
```
/delete 1       # 删除ID为1的任务
```

**功能特性**：
- ✅ 通过任务ID快速删除
- ✅ 删除确认消息
- ✅ 显示已删除任务的详细信息
- ✅ 自动从监控引擎中移除

---

### 4. ⏰ 定时价格汇报

**功能说明**：
用户可自定义汇报间隔和监控币种，实现个性化价格推送

**配置命令**：
```
/report config <间隔分钟> <币种列表>  - 配置汇报参数
/report start                        - 启动汇报
/report stop                         - 停止汇报
/report status                       - 查看当前配置
```

**使用示例**：
```
/report config 30 BTC,ETH,SOL     # 每30分钟汇报BTC、ETH、SOL
/report config 60 BTC,ETH,ADA,BNB # 每60分钟汇报4个币种
/report config 1440 BTC           # 每24小时汇报BTC
/report start                     # 启动汇报
```

**功能特性**：
- ✅ **用户自定义间隔**：5分钟 - 7天任意设置
- ✅ **自由选择币种**：最多可选择10个币种
- ✅ **多用户支持**：每个用户独立配置
- ✅ **数据库持久化**：Bot重启后自动恢复
- ✅ **带专属符号**：₿ ⟠ ₳ ◎ 🔶等加密货币符号
- ✅ **精美排版**：表格式排版，易于阅读
- ✅ **故障转移**：使用多API确保稳定性

**汇报消息示例**：
```
┌─────────────────────────┐
│  📊 价格汇报 03:50:00  │
└─────────────────────────┘

₿ BTC: $89,915.00
⟠ ETH: $3,102.17
◎ SOL: $145.23

─────────────────────────
💡 数据来源: CoinGecko
```

**配置说明**：
- **间隔时间**：最短5分钟，最长7天（10080分钟）
- **币种数量**：单次最多配置10个币种
- **配置更新**：修改配置后需要先stop再start
- **支持币种**：BTC、ETH、SOL、ADA、BNB、DOGE等主流币种

---

### 5. 🔄 多API故障转移

**功能说明**：
自动在多个数据源之间切换，确保价格查询始终可用

**支持的API**：
1. **Cryptocompare API**（主数据源）
   - 提供Binance交易所数据
   - 与TradingView价格一致

2. **CoinGecko API**（备用数据源1）
   - 聚合多个交易所数据
   - 覆盖更多币种

3. **Binance API**（备用数据源2）
   - 官方API直连
   - 最高优先级数据源

**工作原理**：
```
发起价格查询请求
    ↓
检查30秒缓存（命中则直接返回）
    ↓
尝试主API（Cryptocompare）
    ↓ (失败)
自动切换到备用API1（CoinGecko）
    ↓ (失败)
自动切换到备用API2（Binance）
    ↓ (成功)
更新30秒缓存并记录API来源
    ↓
下次优先使用可用的API
```

**功能特性**：
- ✅ **自动切换**：API失败时自动切换到备用源
- ✅ **智能记忆**：记住当前可用的API，提升响应速度
- ✅ **30秒缓存**：减少API调用12倍（从5秒变为30秒检查间隔）
- ✅ **来源显示**：所有消息显示实际使用的API来源
- ✅ **全面覆盖**：所有价格查询都支持故障转移
- ✅ **无感切换**：用户无需感知切换过程
- ✅ **错误日志**：详细记录切换过程便于调试

**应用场景**：
- 价格查询（/price）
- 监控任务检查
- 定时价格汇报
- 任务创建时的币种验证

---

### 6. 👥 用户管理

#### 6.1 🎯 用户注册

**命令**：
```
/start
```

**功能特性**：
- ✅ 自动注册新用户
- ✅ 记录用户ID、用户名、姓名
- ✅ 记录语言偏好
- ✅ 更新已有用户信息
- ✅ 追踪最后活跃时间
- ✅ 友好的欢迎消息

**欢迎消息示例**：
```
👋 欢迎，张三！

━━━━━━━━━━━━━━━━━━━━━━
📊 加密货币价格监控机器人
━━━━━━━━━━━━━━━━━━━━━━

我是您的 Binance 行情监控助手！

✨ 核心功能
• 💰 实时价格查询
• 🔔 价格阈值预警
• 📈 百分比涨跌监控
• ⏰ 定时价格汇报

💡 数据来源
Binance 现货市场（与 TradingView 一致）

🚀 快速开始
/help - 查看完整指令列表
/price BTC - 查询 BTC 当前价格
/add - 创建监控任务

让我们开始吧！
```

#### 6.2 ❓ 帮助文档

**命令**：
```
/help
```

**功能特性**：
- ✅ 完整的命令列表
- ✅ 详细的使用说明
- ✅ 使用示例
- ✅ 功能特性介绍
- ✅ 注意事项说明

---

## ⚙️ 系统特性

### 1. 🔄 监控引擎

**核心能力**：
- ✅ 每30秒自动检查所有活跃任务
- ✅ 30秒价格缓存（减少API调用）
- ✅ 并发检查多个任务（高性能）
- ✅ 自动任务缓存机制
- ✅ 智能错误恢复
- ✅ 5分钟冷却期（防止重复预警）

**技术特性**：
- ✅ 异步编程（asyncio）
- ✅ 并发任务处理
- ✅ 策略模式规则引擎
- ✅ 任务状态管理
- ✅ 自动重连机制

### 2. 💾 数据持久化

**数据库结构**：
- 📊 **用户表**（users）
  - 用户ID、用户名、姓名
  - 语言偏好、活跃状态
  - 创建时间、最后活跃时间

- 📊 **监控任务表**（monitor_tasks）
  - 任务ID、用户ID、币种
  - 规则类型、规则配置
  - 状态、冷却时间
  - 最后触发时间

- 📊 **预警历史表**（alert_history）
  - 预警ID、任务ID、用户ID
  - 触发价格、触发时间
  - 消息内容、发送状态

- 📊 **价格汇报配置表**（report_configs）
  - 用户ID（主键）
  - 是否启用、汇报间隔
  - 监控币种列表
  - 创建/更新时间

- 📊 **系统配置表**（system_config）
  - 配置键、配置值
  - 描述、更新时间

**功能特性**：
- ✅ SQLite数据库
- ✅ SQLAlchemy 2.0 ORM
- ✅ 异步数据库操作
- ✅ 自动表创建
- ✅ 数据库连接池
- ✅ Bot重启后自动恢复所有任务

### 3. 📝 日志系统

**日志文件**：
- 📄 `logs/bot.log` - Bot主日志
- 📄 `logs/monitor.log` - 监控引擎日志
- 📄 `logs/exchange.log` - API调用日志
- 📄 `logs/database.log` - 数据库操作日志

**日志级别**：
- 🔵 DEBUG - 详细调试信息
- 🟢 INFO - 一般信息
- 🟡 WARNING - 警告信息
- 🔴 ERROR - 错误信息
- 🔴 CRITICAL - 严重错误

**功能特性**：
- ✅ 自动日志轮转（10MB一轮）
- ✅ 保留5个备份文件
- ✅ 时间戳记录
- ✅ 异常堆栈追踪
- ✅ 分模块日志记录

### 4. 🛡️ 错误处理

**已实现的错误处理**：
- ✅ API请求错误处理（网络异常、超时）
- ✅ 数据库操作错误处理（连接失败、查询错误）
- ✅ JSON解析错误处理
- ✅ Bot实例验证
- ✅ SQLAlchemy detached instance处理
- ✅ 任务缓存错误恢复
- ✅ 资源清理错误处理
- ✅ 调度器错误处理
- ✅ 消息发送失败处理

**错误恢复机制**：
- ✅ 自动重试机制
- ✅ 优雅降级
- ✅ 错误日志记录
- ✅ 用户友好的错误提示

### 5. 🚀 性能优化

**已实现的优化**：
- ✅ 异步HTTP请求（aiohttp）
- ✅ 并发任务检查
- ✅ 数据库连接池
- ✅ 任务结果缓存
- ✅ 智能价格格式化
- ✅ 消息批量处理

---

## 🔧 系统管理

### 1. 📦 部署方式

**支持的部署方式**：
- ✅ 直接运行（`python main.py`）
- ✅ systemd服务（自动启动、崩溃恢复）
- ✅ 虚拟环境隔离

**systemd服务特性**：
- ✅ 开机自启动
- ✅ 自动崩溃恢复
- ✅ 日志管理（journalctl）
- ✅ 服务状态监控

### 2. ⚙️ 配置管理

**配置文件**：`.env`

**可配置项**：
```env
# Telegram配置
TELEGRAM_BOT_TOKEN=你的TOKEN

# 数据库配置
DATABASE_URL=sqlite+aiosqlite:///./data/crypto_bot.db

# 监控引擎配置
CHECK_INTERVAL=30               # 检查间隔（秒，建议>=30避免API限制）
MAX_CONCURRENT_TASKS=100        # 最大并发任务数
DEFAULT_COOLDOWN=300            # 默认冷却时间（秒）

# 日志配置
LOG_LEVEL=INFO                  # 日志级别
LOG_FILE=logs/bot.log           # 日志文件路径

# 价格汇报配置
REPORT_USER_ID=0                # 接收汇报的用户ID

# 调试模式
DEBUG=False
```

---

## 📊 API 集成

### 1. Cryptocompare API

**使用的端点**：
- `/data/price` - 获取当前价格
- `/data/pricemultifull` - 获取24小时行情
- `/data/v2/histominute` - 获取K线数据（分钟）
- `/data/v2/histohour` - 获取K线数据（小时）
- `/data/v2/histoday` - 获取K线数据（日）

**数据源**：
- 🔗 固定使用Binance交易所数据
- 🔗 与TradingView数据一致
- 🔗 实时更新

**错误处理**：
- ✅ 网络错误自动重试
- ✅ API限流处理
- ✅ 无效币种检测
- ✅ 超时处理

### 2. Telegram Bot API

**使用的功能**：
- 📤 发送消息（send_message）
- 📝 Markdown格式支持
- 👤 用户信息获取
- 🔄 消息更新（编辑、删除）

---

## 🧪 测试覆盖

### 测试统计

| 测试类别 | 测试数量 | 状态 |
|---------|---------|------|
| 监控引擎测试 | 11 | ✅ 全部通过 |
| 价格汇报器测试 | 10 | ✅ 全部通过 |
| 价格阈值规则测试 | 9 | ✅ 全部通过 |
| 百分比规则测试 | 9 | ✅ 全部通过 |
| **总计** | **39** | ✅ **100%通过** |

### 测试覆盖范围

**监控引擎**：
- ✅ 初始化测试
- ✅ Bot验证测试
- ✅ 规则创建测试（JSON解析、类型验证）
- ✅ 启动/停止测试
- ✅ 任务检查测试（冷却期、触发条件）
- ✅ 错误场景测试

**价格汇报器**：
- ✅ 初始化测试
- ✅ Bot验证测试
- ✅ 用户设置测试
- ✅ 消息格式化测试（正常、错误场景）
- ✅ 启动条件测试

**监控规则**：
- ✅ 规则初始化测试（参数验证）
- ✅ 规则评估测试（触发/不触发）
- ✅ 边界条件测试
- ✅ 规则描述测试

---

## 📈 使用统计

### 命令对照表

| 命令 | 功能 | 使用频率 |
|------|------|---------|
| `/start` | 注册用户 | 首次使用 |
| `/help` | 查看帮助 | 需要时 |
| `/price <币种>` | 查询价格 | ⭐⭐⭐⭐⭐ 高频 |
| `/add <参数>` | 创建监控 | ⭐⭐⭐⭐ 常用 |
| `/list` | 查看任务 | ⭐⭐⭐ 常用 |
| `/delete <ID>` | 删除任务 | ⭐⭐ 偶尔 |
| `/report <子命令>` | 配置价格汇报 | ⭐⭐⭐ 常用 |

### 典型使用场景

**场景1：快速查价格**
```
用户: /price BTC
Bot: 显示BTC详细价格信息
```

**场景2：设置价格预警**
```
用户: /add BTC price 50000
Bot: ✅ 监控任务已创建
（当BTC达到50000时）
Bot: 🔴 BTC价格预警...
```

**场景3：管理监控任务**
```
用户: /list
Bot: 显示所有任务列表
用户: /delete 1
Bot: ✅ 任务已删除
```

**场景4：配置价格汇报**
```
用户: /report config 30 BTC,ETH,SOL
Bot: ✅ 汇报配置已保存
     ⏰ 汇报间隔: 30 分钟
     📊 监控币种: BTC, ETH, SOL

用户: /report start
Bot: ✅ 汇报功能已启动

（每30分钟自动）
Bot: 📊 价格汇报 15:30:00
     ₿ BTC: $89,915.00
     ⟠ ETH: $3,102.17
     ◎ SOL: $145.23
```

---

## 🎨 消息格式示例

### 价格查询消息
```markdown
💰 BTC 价格信息

━━━━━━━━━━━━━━━━━━━━━━
📊 当前价格：$89,915.00
━━━━━━━━━━━━━━━━━━━━━━

24h 最高：$90,961.81
24h 最低：$88,459.96
24h 涨跌：+0.73% ↗️
24h 成交量：15,101.53 BTC

⏰ 更新时间：03:45:23
💡 数据来源：CoinGecko
```

### 价格预警消息
```markdown
🔴 BTC 价格预警

━━━━━━━━━━━━━━━━━━━━━━
当前价格: $50,125.00
已达到上限: $50,000.00
━━━━━━━━━━━━━━━━━━━━━━

📈 突破上限阈值！

💡 数据来源: CoinGecko
```

### 百分比预警消息
```markdown
📈 BTC 涨幅预警

━━━━━━━━━━━━━━━━━━━━━━
当前价格: $95,000.00
参考价格: $90,000.00
涨幅: +5.56%
━━━━━━━━━━━━━━━━━━━━━━

🔥 涨幅已达 5%！

💡 数据来源: CoinGecko
```

### 任务列表消息
```markdown
📊 监控任务列表 (2)

✅ BTC
   🔺 上限: $50,000.00
   🆔 ID: 1

✅ ETH
   📌 参考: $3,000.00
   📈 涨 5%
   📉 跌 5%
   🆔 ID: 2

💡 使用 /delete <ID> 删除任务
```

---

## 🔍 技术亮点

### 1. 架构设计
- ✅ **清晰的分层架构**（Bot层、业务层、数据层）
- ✅ **策略模式**（监控规则可扩展）
- ✅ **单例模式**（全局管理器）
- ✅ **工厂模式**（规则创建）
- ✅ **模块化设计**（高内聚低耦合）

### 2. 代码质量
- ✅ **类型注解**（Type Hints）
- ✅ **文档字符串**（完整的函数说明）
- ✅ **异常处理**（完善的错误处理）
- ✅ **日志记录**（分级日志系统）
- ✅ **单元测试**（39个测试用例）

### 3. 性能特性
- ✅ **异步编程**（asyncio + aiohttp）
- ✅ **并发处理**（asyncio.gather）
- ✅ **连接池**（数据库连接复用）
- ✅ **任务缓存**（减少数据库查询）
- ✅ **资源管理**（上下文管理器）

### 4. 可靠性
- ✅ **自动恢复**（systemd服务管理）
- ✅ **数据持久化**（SQLite数据库）
- ✅ **错误处理**（全面的异常捕获）
- ✅ **日志追踪**（完整的操作日志）
- ✅ **冷却机制**（防止频繁预警）

---

## 📚 相关文档

- 📖 [README.md](README.md) - 项目说明文档
- 📖 [.env.example](.env.example) - 配置文件模板
- 📖 [tests/](tests/) - 测试代码

---

## 🎯 总结

这是一个**功能完整、架构清晰、质量可靠**的Telegram加密货币监控机器人，具有：

✅ **7个Telegram命令** - 覆盖所有核心功能
✅ **2种监控规则** - 价格阈值 + 百分比涨跌
✅ **3个数据源** - Cryptocompare + CoinGecko + Binance（自动故障转移）
✅ **30秒价格缓存** - 减少API调用，避免速率限制
✅ **API来源显示** - 所有消息显示数据来源
✅ **智能预警** - 30秒检查频率 + 5分钟冷却
✅ **用户自定义汇报** - 自定义间隔和币种
✅ **数据持久化** - SQLite数据库 + 5张表
✅ **完善测试** - 39个测试用例100%通过
✅ **生产就绪** - systemd服务 + 日志系统

**适用场景**：
- 🎯 个人加密货币投资监控
- 🎯 价格预警自动化
- 🎯 多币种价格追踪
- 🎯 量化交易辅助工具

---

<p align="center">
  <b>📊 Telegram Crypto Monitoring Bot</b>
  <br/>
  <sub>实时监控 · 智能预警 · 自动汇报</sub>
</p>
